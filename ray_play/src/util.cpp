#include "util.h"

double Get2DAngleOfLineSegment(Vector2D A, Vector2D B)
{
	//range:(-PI/2,PI/2)
	double angle = atan((B.y - A.y) / (B.x - A.x));
	
	//range:(-PI/2,-PI/2 + PI*2)
	if(B.x - A.x < 0)
		angle += PI;
	
	//range:(0,PI*2)
	if(B.y - A.y < 0)
		angle += PI * 2;
	if(angle > PI * 2)
		angle -= PI * 2;
	
	return angle;
}

bool GetIntersectionPointsBetweenCircles(const Circle& A, const Circle& B, Vector2D& P1, Vector2D& P2)
{
	//return false if circles too far for any intersections
	if((A.o - B.o).LengthSqr() > (A.r + B.r) * (A.r + B.r))
		return false;

	//find the intersection points of the circles
	//(used this for reference: http://2000clicks.com/mathhelp/GeometryConicSectionCircleIntersection.aspx )
	double dSQ = (A.o - B.o).LengthSqr();
	double K = 0.25 * sqrt(((A.r + B.r) * (A.r + B.r) - dSQ) * (dSQ - (A.r - B.r) * (A.r - B.r)));
	
	P1.x = 0.5 * (B.o.x + A.o.x) + 0.5 * (B.o.x - A.o.x) * (A.r * A.r - B.r * B.r) / dSQ
		+ 2 * (B.o.y - A.o.y) * K / dSQ;
	P2.x = 0.5 * (B.o.x + A.o.x) + 0.5 * (B.o.x - A.o.x) * (A.r * A.r - B.r * B.r) / dSQ
		- 2 * (B.o.y - A.o.y) * K / dSQ;
	
	P1.y = 0.5 * (B.o.y + A.o.y) + 0.5 * (B.o.y - A.o.y) * (A.r * A.r - B.r * B.r) / dSQ 
		- 2 * (B.o.x - A.o.x) * K / dSQ;
	P2.y = 0.5 * (B.o.y + A.o.y) + 0.5 * (B.o.y - A.o.y) * (A.r * A.r - B.r * B.r) / dSQ 
		+ 2 * (B.o.x - A.o.x) * K / dSQ;

	return true;
}

bool GetPointProjectionOntoRay(const Ray& ray, const Vector2D& point, Vector2D& out)
{
	Vector2D rayDir = ray.dir / ray.dir.Length();
	double dotResult = Dot(point - ray.start, rayDir);
	Vector2D proj = dotResult * rayDir;
	out = ray.start + proj;
	
	//return false if projection is behind the ray's start
	return dotResult >= 0;
}

bool IsPointBetweenRays(const Vector2D& Point,
						const Vector2D& ProjectionFirst,
						const Vector2D& ProjectionSecond)
{
	Ray ray(ProjectionSecond, ProjectionFirst - ProjectionSecond);
	Vector2D projection;
	//we check if the point projects onto a ray constructed from the 2 points of
	//a segment (it does not when the projection is behind the begining)
	//and after that we check if it is on the segment itself (considering length)
	if(GetPointProjectionOntoRay(ray, Point, projection))
	{
		if((projection - ProjectionSecond).LengthSqr() < ray.dir.LengthSqr())
		{
			return true;
		}
	}
	
	return false;
}

/*
In the picture below the function IsPointBetweenRays would return true (the 2 rays it is between are the reflected ones)

EPIC ASCII ART GENERATOR BY http://www.glassgiant.com/ascii/
............................................................MI..........................................................
..........................................................M.Z,N.........................................................
.......................................................NM...+..M........................................................
......................................................~....M....M.......................................................
..........................................................:.............................................................
..........................................................O.............................................................
.........................................................~..............................................................
........................................................................................................................
........................................................M...............................................................
........................................................................................................................
.......................................................M................................................................
......M...............................................8.................................................................
.......8I.............................................~.................................................................
.........N...........................................M..................................................................
........8.?...............................................................................................??MMMM$$M.....
........,..N........................................Z...........................................................N.......
.........8..M......................................~..........................................................M...D.....
..........M..N.....................................O........................................................M.....D.....
..................................................M...................MMMD................................M.............
...............N..................................,..................7MMMMM.............................M........M......
................M................................M...................MMMMMM..........................,M.................
.............:...M,.............................~......................8MM..........................M...................
.............:,.................................~.................................................M.....................
..............O....M...........................N................................................M.......................
....................M..........................~..............................................M.........................
.....................M........................M.............................................N...........................
................M....,M......................+............................................O.............................
................,M...........................O.........................................,$...............................
............................................M........................................$,.................................
.........................~.........................................................~~...................................
...................M......:................M.....................................?I.....................................
....................$......I...................................................M........................................
..........................................M..................................=..........................................
.....................7...................O.................................M............................................
..............................M..........:...............................M..............................................
.......................M.......M........M..............................M................................................
................................M......~.............................M..................................................
........................M........O....,O...........................M....................................................
.........................M............=..........................M......................................................
...................................M..+........................M........................................................
..........................O.........MN.......................M..........................................................
...........................M.........M.....................M............................................................
............................=.......M.M..................8..............................................................
............................=......+...................M................................................................
..............................,....:.................M..................................................................
..............................N..,M.......D........D....................................................................
...............................M...........$....,I......................................................................
................................$M..........D.?+........................................................................
..............................,MMMMMM.....MMMMMN........................................................................
.........................$MM~......................MMM..................................................................
......................MM...............................MM:,.............................................................
...................MM.....................................MN,...........................................................
................,M?..........................................N$.........................................................
...............M=..............................................M........................................................
.............M7..................................................M......................................................
............N.....................................................~M....................................................
..........M$........................................................M...................................................
.........N...........................................................M..................................................
........M.............................................................MI................................................
.......M...............................................................O:...............................................
......M,................................................................M...............................................
.....N...................................................................M..............................................
....,M....................................................................M.............................................
....M.....................................................................M.............................................
....+......................................................................M............................................
...M.......................................................................M............................................
...M....................................................................................................................
...D........................................................................D...........................................
...=........................................................................M...........................................
..7.........................................................................M...........................................
..7.........................................................................M...........................................
..I.........................................................................M...........................................
...=........................................................................M...........................................
...M........................................................................Z...........................................
...M.......................................................................M............................................
...+~......................................................................M............................................
....M...................................................................................................................
....N,....................................................................M.............................................
.....M...................................................................N..............................................
......M.................................................................~=..............................................
.......M................................................................M...............................................
........M.............................................................:M................................................
.........M............................................................M.................................................
..........M.........................................................M...................................................
...........M.......................................................M,...................................................
.............M...................................................~M.....................................................
.............,IM...............................................~M.......................................................
................MM...........................................OM.........................................................
...................M+......................................MZ...........................................................
.....................NM:................................NM..............................................................
.........................MM.........................MMN.................................................................
............................,+MMM$...........~8MMM......................................................................
........................................................................................................................
........................................................................................................................
*/
